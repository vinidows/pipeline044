name: Deploy no K8S_CONFIG
on:
    workflow_call:
        inputs:
          environment-name:
              type: string
              required: true
          environment-url:
              type: string
              required: true
          k8s-namespace: 
              type: string
              required: true
              description: 'Namespace do Kubernetes para o deploy.'
        secrets: 
          K8S_CONFIG: 
            required: true
          K8S_NAMESPACE: 
            required: true

jobs:
    Deploy:
      name: "Deploy"
      runs-on: ubuntu-latest
      environment:
          name: ${{ inputs.environment-name }}
          url: ${{ inputs.environment-url }}
      steps:
      - name: Checkout do codigo
        uses: actions/checkout@v5.0.0

      - name: Configuração do Kubernetes
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.K8S_CONFIG }}

      - name: Update deployment
        run: "sed -i 's/host: homologacao.corujaecuidado.com.br/host: ${{ vars.BASE_URL}}/g' k8s/deployment.yaml"

      - name: Deploy do manifesto
        uses: Azure/k8s-deploy@v5
        with:
          namespace: ${{ secrets.K8S_NAMESPACE}}
          manifests: k8s/deployment.yaml
          images: vinidows/pipeline044:v${{ github.run_number }}
